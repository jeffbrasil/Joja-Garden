

class TestDeletarAdmin:
    def test_deletar_admin_sucesso(self, client: TestClient, db_session: Session):
        # 1. Cria e autentica o admin logado (deletador)
        admin_deletador_header = get_admin_header(client)

        # 2. Cria um segundo admin para ser deletado
        admin_a_deletar = {
            "nome": "Admin para Deletar",
            'cpf': "11111111111",
            "senha": "SenhaDeletar123@",
        }
        response_cria = client.post("admin/criar_conta", json=admin_a_deletar)
        admin_id_deletar = response_cria.json()["id"]

        # 3. Deleta o segundo admin
        response = client.delete(f"/admin/{admin_id_deletar}", headers=admin_deletador_header)

        assert response.status_code == status.HTTP_200_OK
        assert f"Administrador {admin_a_deletar['nome']} foi deletado por outro Administrador." in response.json()["message"]
        
        # Verifica se o admin foi realmente deletado (opcional, mas bom)
        response_leitura = client.get(f"/admin/{admin_id_deletar}", headers=admin_deletador_header)
        assert response_leitura.status_code == status.HTTP_404_NOT_FOUND

    def test_deletar_admin_nao_encontrado(self, client: TestClient):
        header = get_admin_header(client)
        admin_id_inexistente = 99999 # Um ID que certamente não existe (MISSING)

        response = client.delete(f"/admin/{admin_id_inexistente}", headers=header)

        assert response.status_code == status.HTTP_404_NOT_FOUND
        assert f"Administrador com ID {admin_id_inexistente} não encontrado." in response.json()["detail"]

    def test_admin_tentar_se_auto_deletar(self, client: TestClient, db_session: Session):
        header = get_admin_header(client)
        
        # Encontra o ID do admin logado (Admin Valido)
        admin_logado = db_session.query(Super_usuario).filter(Super_usuario.cpf == admin_valido['cpf']).first()
        admin_id_logado = admin_logado.id # O admin logado tenta deletar a si mesmo (MISSING)

        response = client.delete(f"/admin/{admin_id_logado}", headers=header)

        assert response.status_code == status.HTTP_400_BAD_REQUEST
        assert "Não é permitido que um administrador se auto-delete." in response.json()["detail"]